\<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JIRA CSV Viewer</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f0f4f8; margin:0; padding:0; }
  .container { max-width: 960px; margin: 2rem auto; padding: 1rem; }
  .card { background: #fff; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .button { padding: 0.5rem 1rem; border-radius: 6px; border: none; cursor: pointer; color: #fff; margin-right: 0.5rem; }
  .btn-upload { background: #2563eb; }
  .btn-export { background: #16a34a; }
  .btn-clear { background: #dc2626; }
  table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
  th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
  th { background: #f3f4f6; }
  .status { display:inline-block; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.85rem; margin-bottom:0.5rem; }
  .green { background:#d1fae5; color:#065f46; }
  .blue { background:#dbeafe; color:#1e40af; }
  .yellow { background:#fef3c7; color:#78350f; }
  .gray { background:#e5e7eb; color:#374151; }
  .purple { background:#ede9fe; color:#5b21b6; }
  .red { background:#fee2e2; color:#991b1b; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useMemo } = React;

const JiraGroupedTable = () => {
  const [expandedStories, setExpandedStories] = useState(new Set());
  const [data, setData] = useState([]);
  const [fileName, setFileName] = useState('');

  // Parse CSV
  const parseCSV = (csvText) => {
    const lines = csvText.split('\n');
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    
    const summaryIdx = headers.findIndex(h => h.toLowerCase().includes('summary'));
    const issueKeyIdx = headers.findIndex(h => h.toLowerCase().includes('issue key'));
    const issueTypeIdx = headers.findIndex(h => h.toLowerCase().includes('issue type'));
    const statusIdx = headers.findIndex(h => h.toLowerCase().includes('status') && !h.toLowerCase().includes('category'));
    const parentKeyIdx = headers.findIndex(h => h.toLowerCase().includes('parent key'));
    const parentSummaryIdx = headers.findIndex(h => h.toLowerCase().includes('parent summary'));
    const timeSpentIdx = headers.findIndex(h => h.toLowerCase().includes('time spent'));
    
    const parsedData = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const values = [];
      let current = '', insideQuotes = false;
      for (let char of lines[i]) {
        if (char === '"') insideQuotes = !insideQuotes;
        else if (char === ',' && !insideQuotes) { values.push(current.trim()); current = ''; }
        else current += char;
      }
      values.push(current.trim());

      if (values.length > 1) {
        let timeSpent = 0;
        if (timeSpentIdx !== -1 && values[timeSpentIdx]) {
          const t = values[timeSpentIdx];
          timeSpent = t.includes('h') ? parseFloat(t)*3600 : parseInt(t) || 0;
        }
        parsedData.push({
          summary: values[summaryIdx] || '',
          issueKey: values[issueKeyIdx] || '',
          issueType: values[issueTypeIdx] || '',
          status: values[statusIdx] || '',
          parentKey: values[parentKeyIdx] || '',
          parentSummary: values[parentSummaryIdx] || '',
          timeSpent
        });
      }
    }
    return parsedData;
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setFileName(file.name);
    const reader = new FileReader();
    reader.onload = (ev) => setData(parseCSV(ev.target.result));
    reader.readAsText(file);
  };

  const clearData = () => {
    setData([]); setFileName(''); setExpandedStories(new Set());
  };

  const groupedData = useMemo(() => {
    if (data.length === 0) return [];
    const groups = {};
    data.forEach(item => {
      const parentKey = item.parentKey || 'No Parent';
      const parentSummary = item.parentSummary || 'No Parent Story';
      const status = item.status;
      if (!groups[parentKey]) groups[parentKey] = { parentKey, parentSummary, statuses:{} };
      if (!groups[parentKey].statuses[status]) groups[parentKey].statuses[status] = [];
      groups[parentKey].statuses[status].push(item);
    });
    return Object.values(groups).sort((a,b)=>a.parentSummary.localeCompare(b.parentSummary));
  }, [data]);

  const toggleStory = (parentKey) => {
    const s = new Set(expandedStories);
    if (s.has(parentKey)) s.delete(parentKey); else s.add(parentKey);
    setExpandedStories(s);
  };

  const formatHours = s => !s ? '0h' : (s/3600).toFixed(1)+'h';
  const getStatusClass = s => {
    const map = { 'Done':'green','Under Review':'blue','In Progress':'yellow','Under Draft':'gray','Review':'purple','blocked':'red','To Do':'gray' };
    return map[s] || 'gray';
  };

  const exportCSV = () => {
    if (data.length===0){ alert('No data to export'); return; }
    const rows=[['Parent Summary','Parent Key','Status','Task Summary','Issue Key','Issue Type','Time Spent (h)']];
    groupedData.forEach(g=>{
      Object.entries(g.statuses).forEach(([status,tasks])=>{
        tasks.forEach((t,i)=>{
          rows.push([
            i===0 && Object.keys(g.statuses)[0]===status?g.parentSummary:'',
            i===0 && Object.keys(g.statuses)[0]===status?g.parentKey:'',
            status,t.summary,t.issueKey,t.issueType,(t.timeSpent/3600).toFixed(1)
          ]);
        });
      });
    });
    const csvContent = rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='jira.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="container">
      <div className="card">
        <h1>JIRA Tasks Viewer</h1>
        <p>Upload a JIRA CSV export to view grouped tasks.</p>
        <div style={{marginTop:'1rem'}}>
          <label className="button btn-upload">ðŸ“¤ Upload CSV
            <input type="file" accept=".csv" onChange={handleFileUpload} style={{display:'none'}} />
          </label>
          {data.length>0 && <>
            <button className="button btn-export" onClick={exportCSV}>ðŸ’¾ Export CSV</button>
            <button className="button btn-clear" onClick={clearData}>ðŸ—‘ Clear</button>
          </>}
        </div>
        {fileName && <p style={{marginTop:'0.5rem'}}>Loaded: {fileName} ({data.length} tasks)</p>}
      </div>

      {data.length===0 ? <div className="card" style={{textAlign:'center'}}>No data loaded.</div> :
        groupedData.map(g=>{
          const expanded = expandedStories.has(g.parentKey);
          return (
            <div key={g.parentKey} className="card">
              <div style={{cursor:'pointer'}} onClick={()=>toggleStory(g.parentKey)}>
                <strong>{expanded?'â–¼ ':'â–¶ '}{g.parentSummary}</strong> ({g.parentKey})
              </div>
              {expanded && Object.entries(g.statuses).map(([status,tasks])=>(
                <div key={status} style={{marginTop:'0.5rem'}}>
                  <div className={`status ${getStatusClass(status)}`}>{status} ({tasks.length})</div>
                  <table>
                    <thead>
                      <tr>
                        <th>Task</th><th>Issue Key</th><th>Type</th><th>Time</th>
                      </tr>
                    </thead>
                    <tbody>
                      {tasks.map(t=>(
                        <tr key={t.issueKey}>
                          <td>{t.summary}</td>
                          <td>{t.issueKey}</td>
                          <td>{t.issueType}</td>
                          <td>{formatHours(t.timeSpent)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ))}
            </div>
          );
        })
      }
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<JiraGroupedTable />);
</script>
</body>
</html>
